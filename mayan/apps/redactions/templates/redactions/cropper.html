{% extends 'appearance/base.html' %}

{% load i18n %}
{% load static %}

{% load common_tags %}

{% block title %}{% blocktrans with object as object %}Redaction coordinates for: {{ object }}{% endblocktrans %}{% endblock title %}

{% block stylesheets %}
    <link href="{% static 'redactions/node_modules/cropperjs/dist/cropper.css' %}" rel="stylesheet">

    <style>
        .cropper-main {
            width: 100%;
        }

        .cropper-main img {
            max-width: 100%;
        }
/*
        .cropper-preview {
            width: 100%;
            overflow: hidden;
        }

        .cropper-preview img {
            max-width: 100%;
        }
*/
    </style>
{% endblock %}

{% block content %}
    <div id="cropper-result"></div>

    <div class="cropper-main">
        <img src="{{ document_page.get_api_image_url }}">
    </div>

    <br>
    {% with '' as title %}
        {% include 'appearance/generic_form_subtemplate.html' %}
    {% endwith %}
{% endblock content %}

{% block javascript %}
    <script>
        var crop_left, crop_top, crop_right, crop_bottom;
        var pic_real_width, pic_real_height;
        var canvasData;
        var containerData;
        var $image = $('.cropper-main img');
        var cropperInstance;

        $.getScript("{% static 'redactions/node_modules/cropperjs/dist/cropper.js' %}")
        .done(function (script, textStatus) {
            $.getScript("{% static 'redactions/node_modules/jquery-cropper/dist/jquery-cropper.js' %}")
            .done(function (script, textStatus) {
                jQuery(document).ready(function () {
                    // Create DOM new image to get the real
                    // (unscaled) image size
                    $('<img/>')
                    .attr('src', $image.attr('src'))
                    .on('load', function () {
                        pic_real_width = this.width;
                        pic_real_height = this.height;
                        console.log('loaded');
                    });

                    cropperInstance = $image.cropper({
                        crop: function (data) {
                            crop_left = (data.detail.x / pic_real_width * 100).toFixed(2);
                            crop_top = (data.detail.y / pic_real_height * 100).toFixed(2);
                            crop_right = (100.001 - (data.detail.x + data.detail.width) / pic_real_width * 100).toFixed(2);
                            crop_bottom = (100.001 - (data.detail.y + data.detail.height) / pic_real_height * 100).toFixed(2);

                            $('#id_left').val(crop_left);
                            $('#id_top').val(crop_top);
                            $('#id_right').val(crop_right);
                            $('#id_bottom').val(crop_bottom);

                            var arguments = {
                                'left': crop_left,
                                'top': crop_top,
                                'right': crop_right,
                                'bottom': crop_bottom,
                                'fillcolor': '#000000',
                            }

                            //$('#id_arguments').text(JSON.stringify(arguments));
                        },
                        mouseWheelZoom: false,
                        movable: false,
                        //preview: '.cropper-preview',
                        ready: function () {
                            canvasData = $image.cropper('getCanvasData');
                            containerData = $image.cropper('getContainerData');
                            var arguments = JSON.parse($('#id_arguments').text());
                            console.log(arguments);

                            $image.cropper('setCropBoxData', {
                                left: Math.round(arguments.left / 100.0 * canvasData.width + canvasData.left),
                                top: Math.round(arguments.top / 100.0 * canvasData.height + canvasData.top),// + canvasData.top),
                                width: Math.round((100.0 - arguments.right - arguments.left) / 100.0 * canvasData.width),// + canvasData.left,
                                height: Math.round((100.0 - arguments.bottom - arguments.top) / 100.0 * canvasData.height),// + canvasData.top),
                            });
                        },
                        rotatable: false,
                        touchDragZoom: false,
                        viewMode: 1,
                        zoomable: false,
                    });
                })
            })
        });
    </script>
{% endblock %}
